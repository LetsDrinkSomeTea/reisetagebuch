{% assign scope = include.scope | default: 'all' %}
{% assign country_filter = include.country %}
{% assign city_filter = include.city %}
{% assign image_types = site.data['image-types'] %}
{% assign allowed_ext = 'jpg,jpeg,png,webp,avif' | split: ',' %}
{% assign gallery_markup = '' %}
{% assign item_count = 0 %}

{% assign gallery_id_seed = page.url | append: '-' | append: scope %}
{% if country_filter %}{% assign gallery_id_seed = gallery_id_seed | append: '-' | append: country_filter %}{% endif %}
{% if city_filter %}{% assign gallery_id_seed = gallery_id_seed | append: '-' | append: city_filter %}{% endif %}
{% assign gallery_id = gallery_id_seed | replace: '/', '-' | replace: '.', '-' | replace: ' ', '-' %}

{% assign day_pages = site.pages | where: 'layout', 'day' %}

{% for static in site.static_files %}
  {% assign file_path = static.path %}
  {% if file_path contains '/journeys/' and file_path contains '/tag-' %}
    {% assign ext = static.extname | remove_first: '.' | downcase %}
    {% if allowed_ext contains ext %}
      {% assign trimmed_path = file_path | remove_first: '/' %}
      {% assign segments = trimmed_path | split: '/' %}
      {% if segments.size >= 4 %}
        {% assign journey_key = segments[1] %}
        {% assign tag_folder = segments[2] %}
        {% assign file_name = segments[3] %}
        {% assign basename = file_name | split: '.' | first %}
        {% assign day_number_string = tag_folder | remove: 'tag-' %}
        {% if day_number_string != tag_folder %}
          {% assign day_number = day_number_string | plus: 0 %}
          {% assign journey_day_candidates = day_pages | where: 'journey', journey_key %}
          {% assign day_page = journey_day_candidates | where: 'day', day_number | first %}
          {% if day_page %}
            {% assign includes_image = true %}
            {% if scope == 'country' %}
              {% if day_page.country != country_filter or basename != 'main' %}
                {% assign includes_image = false %}
              {% endif %}
            {% elsif scope == 'city' %}
              {% assign city_list = day_page.city | array %}
              {% unless day_page.country == country_filter and city_list contains city_filter and basename == 'main' %}
                {% assign includes_image = false %}
              {% endunless %}
            {% endif %}
            {% if includes_image %}
              {% assign journey_data = site.data.journeys[journey_key] %}
              {% assign journey_name = journey_data.name | default: journey_key %}
              {% assign country_data = site.data.countries[day_page.country] %}

              {% assign city_keys_raw = day_page.city | array %}
              {% assign city_keys = '' | split: '' %}
              {% for ck in city_keys_raw %}
                {% if ck %}
                  {% assign city_keys = city_keys | push: ck %}
                {% endif %}
              {% endfor %}
              {% assign primary_city_key = city_keys | first %}

              {% assign city_names = '' | split: '' %}
              {% assign city_emojis = '' | split: '' %}
              {% for ck in city_keys %}
                {% assign city_info = nil %}
                {% if country_data and country_data.cities %}
                  {% assign city_info = country_data.cities[ck] %}
                {% endif %}
                {% assign city_name_value = city_info.name | default: ck %}
                {% assign city_emoji_value = city_info.emoji | default: '' %}
                {% assign city_names = city_names | push: city_name_value %}
                {% assign city_emojis = city_emojis | push: city_emoji_value %}
              {% endfor %}

              {% assign primary_city_name = city_names | first | default: primary_city_key %}
              {% assign primary_city_emoji = city_emojis | first | default: '' %}
              {% assign country_name = country_data.name | default: day_page.country %}
              {% assign country_flag = country_data.flag | default: '' %}

              {% assign city_names_attr = city_names | join: '|' | escape %}
              {% assign city_names_attr = city_names_attr | replace: "'", '&#39;' %}
              {% assign city_keys_attr = city_keys | join: ' ' %}
              {% assign journey_name_attr = journey_name | escape | replace: "'", '&#39;' %}
              {% assign country_name_attr = country_name | escape | replace: "'", '&#39;' %}

              {% assign image_type = image_types[basename] %}
              {% assign image_label = image_type.name | default: basename | replace: '-', ' ' | capitalize %}
              {% assign title_text = primary_city_emoji | append: ' ' | append: primary_city_name | append: ' · Tag ' | append: day_page.day | append: ' · ' | append: image_label %}
              {% assign alt_text = image_label | append: ' – Tag ' | append: day_page.day | append: ' in ' | append: primary_city_name | append: ', ' | append: country_name %}
              {% capture location_label %}
                {% if primary_city_emoji %}{{ primary_city_emoji }} {% endif %}{{ primary_city_name }}
                {% if country_flag or country_name %}
                  · {% if country_flag %}{{ country_flag }} {% endif %}{{ country_name }}
                {% endif %}
              {% endcapture %}
              {% assign location_label = location_label | strip %}
              {% assign image_url = file_path | relative_url %}
              {% assign index_value = item_count %}
              {% capture gallery_markup %}
                {{ gallery_markup }}
                <figure class="gallery__card" data-filter-item data-journey="{{ journey_key }}" data-journey-names="{{ journey_name_attr }}" data-country="{{ day_page.country }}" data-country-names="{{ country_name_attr }}" data-city="{{ city_keys_attr }}" data-city-names="{{ city_names_attr }}">
                  <a class="gallery__link" href="{{ image_url }}" data-gallery="{{ gallery_id }}" data-gallery-index="{{ index_value }}" data-gallery-src="{{ image_url }}" data-gallery-alt="{{ alt_text | escape }}" data-gallery-title="{{ title_text | escape }}">
                    <div class="gallery__media">
                      <img src="{{ image_url }}" alt="{{ alt_text | escape }}" loading="lazy" decoding="async">
                    </div>
                    <div class="gallery__meta">
                      <div class="gallery__location">{{ location_label }}</div>
                      <div class="gallery__badges">
                        <span class="badge badge--primary">Tag {{ day_page.day }}</span>
                        <span class="badge badge--light">{{ image_label }}</span>
                      </div>
                    </div>
                  </a>
                </figure>
              {% endcapture %}
              {% assign item_count = item_count | plus: 1 %}
            {% endif %}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endfor %}

{% if item_count > 0 %}
  <div class="gallery gallery--{{ scope }}" data-gallery="{{ gallery_id }}"{% if include.dom_id %} id="{{ include.dom_id }}"{% endif %}>
    {{ gallery_markup | strip }}
  </div>
{% elsif include.show_empty != false %}
  <p class="gallery-empty">Hier erscheinen Bilder, sobald passende Medien vorhanden sind.</p>
{% endif %}
