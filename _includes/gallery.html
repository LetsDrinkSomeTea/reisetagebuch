{% comment %}
Unified Gallery Component - Complete gallery system with integrated image discovery
Parameters:
- scope: "all", "country", "city" - determines gallery type
- country: country key (required for "country" and "city" scope)  
- city: city key (required for "city" scope)
- title: optional gallery title (auto-generated if not provided)
- show_stats: boolean - whether to show gallery statistics (default: false)

Usage:
{% include gallery.html scope="city" country="japan" city="tokyo" %}
{% include gallery.html scope="country" country="japan" title="Bilder aus Japan" %}
{% include gallery.html scope="all" show_stats=true %}
{% endcomment %}

{% comment %} Integrated Image Discovery System {% endcomment %}
{% assign images_found = false %}
{% assign discovered_images = "" | split: "" %}
{% assign image_extensions = "jpg,jpeg,JPG,JPEG" | split: "," %}

{% comment %} Define scope flags (journey-centric: unsere-grosse-reise) {% endcomment %}
{% assign scope_mode = include.scope | default: 'all' %}

{% comment %} Discover and process images in one pass {% endcomment %}
{% for file in site.static_files %}
  {% if file.path contains "/journeys/" and file.path contains "/tag-" %}
    {% assign extension_match = false %}
    {% for ext in image_extensions %}
      {% if file.extname contains ext %}
        {% assign extension_match = true %}
        {% break %}
      {% endif %}
    {% endfor %}
    
    {% if extension_match %}
      {% assign path_parts = file.path | split: "/" %}
      {% if path_parts.size >= 3 %}
        {% assign tag_dir = path_parts[-2] %}
        {% assign image_name = path_parts[-1] | split: "." | first | split: "-" | first %}
        {% assign day_label = tag_dir | remove: "tag-" %}

        {% comment %} Find the matching day page to derive country/city {% endcomment %}
        {% assign candidate_pages = site.pages | where: "layout", "day" %}
        {% assign candidate_pages = candidate_pages | where: "journey", "unsere-grosse-reise" %}
        {% assign matched_page = candidate_pages | where: "day", day_label | first %}

        {% if matched_page %}
          {% assign file_country = matched_page.country %}
          {% assign file_city = matched_page.city %}
          {% assign file_journey = matched_page.journey %}
          {% assign file_date = matched_page.date | date: '%Y-%m-%d' %}

          {% comment %} Scope filter: for city/country views only include main images {% endcomment %}
          {% assign include_file = false %}
          {% if scope_mode == "all" %}
            {% assign include_file = true %}
          {% elsif scope_mode == "country" and include.country == file_country and file.path contains "main" %}
            {% assign include_file = true %}
          {% elsif scope_mode == "city" and include.country == file_country and include.city == file_city and file.path contains "main" %}
            {% assign include_file = true %}
          {% endif %}

          {% if include_file %}
            {% assign image_obj = "" | split: "" %}
            {% assign image_obj = image_obj | push: file.path %}
            {% assign image_obj = image_obj | push: file_country %}
            {% assign image_obj = image_obj | push: file_city %}
            {% assign image_obj = image_obj | push: day_label %}
            {% assign image_obj = image_obj | push: image_name %}
            {% assign image_obj = image_obj | push: file_journey %}
            {% assign image_obj = image_obj | push: file_date %}
            {% assign discovered_images = discovered_images | push: image_obj %}
            {% assign images_found = true %}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %} Sort images hierarchically: country -> city -> day -> image type {% endcomment %}
{% if images_found %}
  {% assign images_with_sort_keys = "" | split: "" %}
  
  {% comment %} Build country position lookup {% endcomment %}
  {% assign country_index = 0 %}
  {% for country in site.data.countries %}
    {% assign country_key = country[0] %}
    
    {% comment %} Build city position lookup for this country {% endcomment %}
    {% assign country_data = country[1] %}
    {% assign city_index = 0 %}
    {% for city in country_data.cities %}
      {% assign city_key = city[0] %}
      {% assign city_index = city_index | plus: 1 %}
    {% endfor %}
    {% assign country_index = country_index | plus: 1 %}
  {% endfor %}
  
  {% comment %} Build image type position lookup {% endcomment %}
  {% assign type_index = 0 %}
  {% for image_type in site.data.image-types %}
    {% assign type_key = image_type[0] %}
    {% assign type_index = type_index | plus: 1 %}
  {% endfor %}
  
  {% comment %} Process each image and create sort keys {% endcomment %}
  {% for image_data in discovered_images %}
    {% assign image_country = image_data[1] %}
    {% assign image_city = image_data[2] %}
    {% assign day_label = image_data[3] %}
    {% assign day_base = day_label | remove: 'b' | plus: 0 %}
    {% assign is_b = 0 %}
    {% if day_label contains 'b' %}
      {% assign is_b = 1 %}
    {% endif %}
    {% assign image_type = image_data[4] %}
    {% assign image_journey = image_data[5] %}
    {% assign image_date = image_data[6] %}
    
    {% comment %} Find country position {% endcomment %}
    {% assign country_pos = 999 %}
    {% assign country_index = 0 %}
    {% for country in site.data.countries %}
      {% assign country_key = country[0] %}
      {% if country_key == image_country %}
        {% assign country_pos = country_index %}
        {% break %}
      {% endif %}
      {% assign country_index = country_index | plus: 1 %}
    {% endfor %}
    
    {% comment %} Find city position within country {% endcomment %}
    {% assign city_pos = 999 %}
    {% if country_pos != 999 %}
      {% assign country_data = site.data.countries[image_country] %}
      {% assign city_index = 0 %}
      {% for city in country_data.cities %}
        {% assign city_key = city[0] %}
        {% if city_key == image_city %}
          {% assign city_pos = city_index %}
          {% break %}
        {% endif %}
        {% assign city_index = city_index | plus: 1 %}
      {% endfor %}
    {% endif %}
    
    {% comment %} Find image type position {% endcomment %}
    {% assign type_pos = 999 %}
    {% assign type_index = 0 %}
    {% for image_type_entry in site.data.image-types %}
      {% assign type_key = image_type_entry[0] %}
      {% if type_key == image_type %}
        {% assign type_pos = type_index %}
        {% break %}
      {% endif %}
      {% assign type_index = type_index | plus: 1 %}
    {% endfor %}
    
    {% comment %} Create sort key: country_pos-city_pos-day_base-is_b-type_pos {% endcomment %}
    {% assign sort_key = country_pos | append: "-" | append: city_pos | append: "-" %}
    {% if day_base < 10 %}{% assign sort_key = sort_key | append: "0" %}{% endif %}
    {% assign sort_key = sort_key | append: day_base | append: "-" | append: is_b | append: "-" %}
    {% if type_pos < 10 %}{% assign sort_key = sort_key | append: "0" %}{% endif %}
    {% assign sort_key = sort_key | append: type_pos %}
    
    {% comment %} Combine sort key with image data {% endcomment %}
    {% assign image_with_key = "" | split: "" %}
    {% assign image_with_key = image_with_key | push: sort_key %}
    {% for item in image_data %}
      {% assign image_with_key = image_with_key | push: item %}
    {% endfor %}
    {% assign images_with_sort_keys = images_with_sort_keys | push: image_with_key %}
  {% endfor %}
  
  {% comment %} Sort by the sort key {% endcomment %}
  {% assign sorted_images_with_keys = images_with_sort_keys | sort %}
  
  {% comment %} Extract sorted images (remove sort keys) {% endcomment %}
  {% assign discovered_images = "" | split: "" %}
  {% for image_with_key in sorted_images_with_keys %}
    {% assign clean_image = "" | split: "" %}
    {% for i in (1..7) %}
      {% assign clean_image = clean_image | push: image_with_key[i] %}
    {% endfor %}
    {% assign discovered_images = discovered_images | push: clean_image %}
  {% endfor %}
{% endif %}

{% comment %} Render gallery if images found {% endcomment %}
{% if images_found %}
  {% comment %} Generate title if not provided {% endcomment %}
  {% unless include.title %}
    {% case include.scope %}
      {% when "city" %}
        {% assign city_data = site.data.countries[include.country].cities[include.city] %}
        {% assign gallery_title = "üì∏ Bilder aus " | append: city_data.name %}
      {% when "country" %}
        {% assign country_data = site.data.countries[include.country] %}
        {% assign gallery_title = "üì∏ Bilder aus " | append: country_data.name %}
      {% when "all" %}
        {% assign gallery_title = "üì∏ Alle Bilder" %}
    {% endcase %}
  {% else %}
    {% assign gallery_title = include.title %}
  {% endunless %}

  {% comment %} Optional statistics display {% endcomment %}
  {% if include.show_stats %}
    {% assign countries_list = "" | split: "" %}
    {% assign cities_list = "" | split: "" %}
    
    {% for image_data in discovered_images %}
      {% assign image_country = image_data[1] %}
      {% assign image_city = image_data[2] %}
      {% assign city_identifier = image_country | append: "-" | append: image_city %}
      
      {% unless countries_list contains image_country %}
        {% assign countries_list = countries_list | push: image_country %}
      {% endunless %}
      {% unless cities_list contains city_identifier %}
        {% assign cities_list = cities_list | push: city_identifier %}
      {% endunless %}
    {% endfor %}

    <div class="gallery__stats">
      <span class="stat-item">üì∏ {{ discovered_images.size }} {% if discovered_images.size == 1 %}Bild{% else %}Bilder{% endif %}</span>
      {% if include.scope == "all" %}
        <span class="stat-item">üåç {{ countries_list.size }} {% if countries_list.size == 1 %}Land{% else %}L√§nder{% endif %}</span>
        <span class="stat-item">üèôÔ∏è {{ cities_list.size }} {% if cities_list.size == 1 %}Stadt{% else %}St√§dte{% endif %}</span>
      {% endif %}
    </div>
  {% endif %}

  <section class="gallery__section">
    {% if gallery_title %}
      <h2>{{ gallery_title }}</h2>
    {% endif %}
    {% if scope_mode == 'all' %}
      <div class="gallery__controls" aria-label="Filter">
        <label>
          Land:
          <select id="galleryFilterCountry">
            <option value="">Alle</option>
            {% assign countries_list = discovered_images | map: 1 | uniq %}
            {% for c in countries_list %}
              <option value="{{ c }}">{{ site.data.countries[c].name | default: c }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Stadt:
          <select id="galleryFilterCity">
            <option value="">Alle</option>
            {% assign city_idents = "" | split: "" %}
            {% for img in discovered_images %}
              {% assign ident = img[1] | append: ":" | append: img[2] %}
              {% unless city_idents contains ident %}
                {% assign city_idents = city_idents | push: ident %}
              {% endunless %}
            {% endfor %}
            {% for ident in city_idents %}
              {% assign parts = ident | split: ":" %}
              {% assign ctry = parts[0] %}
              {% assign cty = parts[1] %}
              <option value="{{ cty }}" data-country="{{ ctry }}">{{ site.data.countries[ctry].cities[cty].name | default: cty }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Sortierung:
          <select id="gallerySort">
            <option value="date-desc">Neueste zuerst</option>
            <option value="date-asc">√Ñlteste zuerst</option>
          </select>
        </label>
      </div>
    {% endif %}
    <div class="gallery">
      {% for image_data in discovered_images %}
        {% assign image_path = image_data[0] %}
        {% assign country_key = image_data[1] %}
        {% assign city_key = image_data[2] %}
        {% assign day_number = image_data[3] %}
        {% assign image_type = image_data[4] %}
        {% assign journey_key = image_data[5] %}
        {% assign image_date = image_data[6] %}
        
        {% comment %} Get country and city display data {% endcomment %}
        {% assign country_data = site.data.countries[country_key] %}
        {% assign city_data = country_data.cities[city_key] %}
        {% assign city_name = city_data.name | default: city_key %}
        {% assign city_emoji = city_data.emoji | default: "üèôÔ∏è" %}
        
        {% comment %} Get image type display data {% endcomment %}
        {% assign image_type_data = site.data.image-types[image_type] %}
        {% assign image_display_name = image_type_data.name | default: image_type %}
        {% assign image_icon = image_type_data.icon | default: "üñºÔ∏è" %}
        
        {% comment %} Build modal title and alt text {% endcomment %}
        {% assign base_title = "Tag " | append: day_number | append: ", " | append: city_name | append: ", " | append: country_data.name %}
        {% if include.scope == "all" %}
          {% assign modal_title = base_title | append: " - " | append: image_icon | append: " " | append: image_display_name %}
        {% else %}
          {% assign modal_title = base_title %}
        {% endif %}
        {% assign alt_text = "Bild aus " | append: city_name | append: ", Tag " | append: day_number %}

        <div class="gallery__card" data-country="{{ country_key }}" data-city="{{ city_key }}" data-journey="{{ journey_key }}" data-date="{{ image_date }}" data-day="{{ day_number }}" data-type="{{ image_type }}">
          <a href="{{ image_path | relative_url }}" class="gallery__link" 
             title="{{ modal_title }}"
             data-modal-title="{{ modal_title }}">
            <div class="gallery__image-container">
              <img src="{{ image_path | relative_url }}" 
                   alt="{{ alt_text }}" 
                   loading="lazy" />
              <div class="gallery__overlay">
                <div class="gallery__info">
                  {% case include.scope %}
                    {% when "city" %}
                      <span class="badge badge--primary">Tag {{ day_number }}</span>
                    {% when "country" %}
                      <span class="badge badge--light">{{ city_emoji }} {{ city_name }}</span>
                      <span class="badge badge--primary">Tag {{ day_number }}</span>
                    {% when "all" %}
                      <span class="badge badge--light">{{ city_emoji }} {{ city_name }}</span>
                      <span class="badge badge--light">{{ image_icon }}</span>
                      <span class="badge badge--primary">Tag {{ day_number }}</span>
                  {% endcase %}
                </div>
              </div>
            </div>
          </a>
        </div>
      {% endfor %}
    </div>
  </section>

  {% comment %} Re-initialize gallery links for modal system {% endcomment %}
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    if (window.reinitGallery) {
      window.reinitGallery();
    }
  });
  </script>
{% else %}
  {% comment %} Show no images message for "all" scope only {% endcomment %}
  {% if include.scope == "all" %}
    <div class="no-entries">
      <p>üöÄ Noch keine Bilder vorhanden. Die ersten Fotos erscheinen hier, sobald die Reise beginnt!</p>
    </div>
  {% endif %}
{% endif %}
