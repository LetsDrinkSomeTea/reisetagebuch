{% assign scope = include.scope | default: 'all' %}
{% assign country_filter = include.country %}
{% assign city_filter = include.city %}
{% assign image_types = site.data['image-types'] %}
{% assign allowed_ext = 'jpg,jpeg,png,webp,avif' | split: ',' %}
{% assign image_type_keys = '' | split: '' %}
{% for type_entry in image_types %}
  {% assign image_type_keys = image_type_keys | push: type_entry[0] %}
{% endfor %}
{% assign gallery_markup = '' %}
{% assign item_count = 0 %}

{% assign gallery_id_seed = page.url | append: '-' | append: scope %}
{% if country_filter %}{% assign gallery_id_seed = gallery_id_seed | append: '-' | append: country_filter %}{% endif %}
{% if city_filter %}{% assign gallery_id_seed = gallery_id_seed | append: '-' | append: city_filter %}{% endif %}
{% assign gallery_id = gallery_id_seed | replace: '/', '-' | replace: '.', '-' | replace: ' ', '-' %}

{% assign day_pages = site.pages | where: 'layout', 'day' %}

{% assign gallery_static_files = site.static_files | where_exp: 'static', "static.path contains '/journeys/'" %}
{% assign gallery_static_files = gallery_static_files | where_exp: 'static', "static.path contains '/tag-'" %}

{% assign sorted_day_pages = day_pages | sort: 'date' %}
{% assign gallery_items = '' | split: '' %}

{% for day_page in sorted_day_pages %}
  {% assign journey_key = day_page.journey %}
  {% assign day_number = day_page.day %}
  {% assign day_folder = '/journeys/' | append: journey_key | append: '/tag-' | append: day_number | append: '/' %}
  {% assign day_number_string = day_number | append: '' %}
  {% assign day_sort = day_number_string | prepend: '0000' %}
  {% assign day_sort = day_sort | slice: -4, 4 %}
  {% assign day_static_files = gallery_static_files | where_exp: 'static', "static.path contains day_folder" %}
  {% for static in day_static_files %}
    {% assign ext = static.extname | remove_first: '.' | downcase %}
    {% if allowed_ext contains ext %}
      {% assign trimmed_path = static.path | remove_first: '/' %}
      {% assign segments = trimmed_path | split: '/' %}
      {% if segments.size >= 4 %}
        {% assign file_name = segments[3] %}
        {% assign basename = file_name | split: '.' | first %}
        {% assign basename_parts = basename | split: '-' %}
        {% assign base_type = basename_parts | first %}
        {% assign type_index = image_type_keys.size %}
        {% for type_key in image_type_keys %}
          {% if type_key == base_type %}
            {% assign type_index = forloop.index0 %}
            {% break %}
          {% endif %}
        {% endfor %}
        {% assign suffix_number = 0 %}
        {% if basename_parts.size > 1 %}
          {% assign suffix_candidate = basename_parts | last %}
          {% assign suffix_number = suffix_candidate | plus: 0 %}
        {% endif %}
        {% assign date_value = day_page.date %}
        {% if date_value %}
          {% assign date_key = date_value | date: '%Y-%m-%d' %}
        {% else %}
          {% assign date_key = '9999-12-31' %}
        {% endif %}
        {% assign type_index_string = type_index | append: '' %}
        {% assign type_index_string = type_index_string | prepend: '0000' %}
        {% assign type_index_string = type_index_string | slice: -4, 4 %}
        {% assign suffix_string = suffix_number | append: '' %}
        {% assign suffix_string = suffix_string | prepend: '0000' %}
        {% assign suffix_string = suffix_string | slice: -4, 4 %}
        {% capture sort_key %}{{ date_key }}|{{ journey_key }}|{{ day_sort }}|{{ type_index_string }}|{{ suffix_string }}|{{ basename }}|{{ static.path }}{% endcapture %}
        {% assign gallery_items = gallery_items | push: sort_key %}
      {% endif %}
    {% endif %}
  {% endfor %}
{% endfor %}

{% assign gallery_items = gallery_items | sort_natural %}

{% for item in gallery_items %}
  {% assign item_parts = item | split: '|' %}
  {% assign file_path = item_parts | last %}
  {% assign ext = file_path | split: '.' | last | downcase %}
  {% if allowed_ext contains ext %}
    {% assign trimmed_path = file_path | remove_first: '/' %}
    {% assign segments = trimmed_path | split: '/' %}
    {% if segments.size >= 4 %}
      {% assign journey_key = segments[1] %}
      {% assign tag_folder = segments[2] %}
      {% assign file_name = segments[3] %}
      {% assign basename = file_name | split: '.' | first %}
      {% assign basename_parts = basename | split: '-' %}
      {% assign base_type = basename_parts | first %}
      {% assign day_number_string = tag_folder | remove: 'tag-' %}
      {% if day_number_string != tag_folder %}
        {% assign day_number = day_number_string | plus: 0 %}
        {% assign journey_day_candidates = day_pages | where: 'journey', journey_key %}
        {% assign day_page = journey_day_candidates | where: 'day', day_number | first %}
        {% if day_page %}
          {% comment %} Auto-detect country from first city {% endcomment %}
          {% assign day_country = day_page.country %}
          {% unless day_country %}
            {% assign first_city = day_page.city | array | first %}
            {% if first_city %}
              {% assign first_city_data = site.data.cities[first_city] %}
              {% if first_city_data %}
                {% assign day_country = first_city_data.country %}
              {% endif %}
            {% endif %}
          {% endunless %}
          
          {% assign includes_image = true %}
          {% if scope == 'country' %}
            {% if day_country != country_filter or basename != 'main' %}
              {% assign includes_image = false %}
            {% endif %}
          {% elsif scope == 'city' %}
            {% assign city_list = day_page.city | array %}
            {% unless day_country == country_filter and city_list contains city_filter and basename == 'main' %}
              {% assign includes_image = false %}
            {% endunless %}
          {% endif %}
          {% if includes_image %}
            {% assign journey_data = site.data.journeys[journey_key] %}
            {% assign journey_name = journey_data.name | default: journey_key %}
            
            {% comment %} Auto-detect country from first city {% endcomment %}
            {% assign gallery_country = day_page.country %}
            {% unless gallery_country %}
              {% assign first_city = day_page.city | array | first %}
              {% if first_city %}
                {% assign first_city_data = site.data.cities[first_city] %}
                {% if first_city_data %}
                  {% assign gallery_country = first_city_data.country %}
                {% endif %}
              {% endif %}
            {% endunless %}
            {% assign country_data = site.data.countries[gallery_country] %}

            {% assign city_keys_raw = day_page.city | array %}
            {% assign city_keys = '' | split: '' %}
            {% for ck in city_keys_raw %}
              {% if ck %}
                {% assign city_keys = city_keys | push: ck %}
              {% endif %}
            {% endfor %}
            {% assign primary_city_key = city_keys | first %}

            {% assign city_names = '' | split: '' %}
            {% assign city_emojis = '' | split: '' %}
            {% for ck in city_keys %}
              {% assign city_info = site.data.cities[ck] %}
              {% assign city_name_value = city_info.name | default: ck %}
              {% assign city_emoji_value = city_info.emoji | default: '' %}
              {% assign city_names = city_names | push: city_name_value %}
              {% assign city_emojis = city_emojis | push: city_emoji_value %}
            {% endfor %}

            {% assign primary_city_name = city_names | first | default: primary_city_key %}
            {% assign primary_city_emoji = city_emojis | first | default: '' %}
            {% assign country_name = country_data.name | default: gallery_country %}
            {% assign country_flag = country_data.flag | default: '' %}

            {% assign city_names_attr = city_names | join: '|' | escape %}
            {% assign city_names_attr = city_names_attr | replace: "'", '&#39;' %}
            {% assign city_keys_attr = city_keys | join: ' ' %}
            {% assign journey_name_attr = journey_name | escape | replace: "'", '&#39;' %}
            {% assign country_name_attr = country_name | escape | replace: "'", '&#39;' %}

            {% assign image_type = image_types[basename] %}
            {% if image_type == nil %}
              {% assign image_type = image_types[base_type] %}
            {% endif %}
            {% assign image_label = image_type.name | default: basename | replace: '-', ' ' %}
            {% assign title_text = primary_city_emoji | append: ' ' | append: primary_city_name | append: ' · Tag ' | append: day_page.day | append: ' · ' | append: image_label %}
            {% assign alt_text = image_label | append: ' – Tag ' | append: day_page.day | append: ' in ' | append: primary_city_name | append: ', ' | append: country_name %}
            {% capture location_label %}
              {% if primary_city_emoji %}{{ primary_city_emoji }} {% endif %}{{ primary_city_name }}
              {% if country_flag or country_name %}
                · {% if country_flag %}{{ country_flag }} {% endif %}{{ country_name }}
              {% endif %}
            {% endcapture %}
            {% assign location_label = location_label | strip %}
            {% assign image_url = file_path | relative_url %}
            {% assign index_value = item_count %}
            {% capture gallery_markup %}
              {{ gallery_markup }}
              <figure class="gallery__card" data-filter-item data-journey="{{ journey_key }}" data-journey-names="{{ journey_name_attr }}" data-country="{{ day_page.country }}" data-country-names="{{ country_name_attr }}" data-city="{{ city_keys_attr }}" data-city-names="{{ city_names_attr }}">
                <a class="gallery__link" href="{{ image_url }}" data-gallery="{{ gallery_id }}" data-gallery-index="{{ index_value }}" data-gallery-src="{{ image_url }}" data-gallery-alt="{{ alt_text | escape }}" data-gallery-title="{{ title_text | escape }}">
                  <div class="gallery__media">
                    <img src="{{ image_url }}" alt="{{ alt_text | escape }}" loading="lazy" decoding="async">
                  </div>
                  <div class="gallery__meta">
                    <div class="gallery__location">{{ location_label }}</div>
                    <div class="gallery__badges">
                      <span class="badge badge--primary">Tag {{ day_page.day }}</span>
                      <span class="badge badge--light">{{ image_label }}</span>
                    </div>
                  </div>
                </a>
              </figure>
            {% endcapture %}
            {% assign item_count = item_count | plus: 1 %}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endfor %}

{% if scope == "city" or scope == "country" %}
  <h2>Galerie</h2>
{% endif %}
{% if item_count > 0 %}
  <div class="gallery gallery--{{ scope }}" data-gallery="{{ gallery_id }}"{% if include.dom_id %} id="{{ include.dom_id }}"{% endif %}>
    {{ gallery_markup | strip }}
  </div>
{% elsif include.show_empty != false %}
  <p class="gallery-empty">Hier erscheinen Bilder, sobald passende Medien vorhanden sind.</p>
{% endif %}
